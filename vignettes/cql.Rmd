---
title: "Chronological Query Language (CQL)"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Chronological Query Language (CQL)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Chronological Query Language (CQL) is a tool for formally describing chronological models [@Bronk_Ramsey1998-zw].
It is most commonly used to input data for Bayesian radiocarbon calibration in [OxCal](https://c14.arch.ox.ac.uk/oxcal.html) [@Bronk_Ramsey2009-yk].
`stratigraphr` includes an R interface for CQL2, the version used in OxCal v3+.

This vignette describes how to use this interface to generate CQL models in R.

## Overview

* Individual CQL commands (see <https://c14.arch.ox.ac.uk/oxcalhelp/hlp_commands.html>) are implemented as `cql_*` functions.
* Use `cql()` to group together CQL functions or include arbitrary CQL code.
* Execute CQL scripts in OxCal using `write_oxcal()` or the [oxcAAR package](https://CRAN.R-project.org/package=oxcAAR).


## Writing CQL scripts

```{r setup}
library("stratigraphr")
```

## Executing CQL scripts

You can run models generated by `cql()` using the desktop or online versions of OxCal by simply copying the output into the program.
Alternatively, use `write_oxcal()` to create a .oxcal file:

```{r write-oxcal}
oxcal_cql <- cql(
  cql_r_date("ABC-001", 9100, 30),
  cql_r_date("ABC-002", 9200, 30),
  cql_r_date("ABC-003", 9300, 30)
)

write_oxcal(oxcal_cql, "cql.oxcal")
```
```{r write-oxcal-cleanup, include=FALSE}
fs::file_delete("cql.oxcal")
```

You can also run OxCal directly through R using the [oxcAAR](https://CRAN.R-project.org/package=oxcAAR) package.
This depends on a local installation of OxCal.
If you already have one installed, you can set the path to the executable using `oxcAAR::setOxcalExecutablePath()`.
Otherwise, use `oxcAAR::quickSetupOxcal()` to download one, for example to a temporary directory:

```{r oxcaar-setup, results=FALSE, message=FALSE}
library("oxcAAR")
quickSetupOxcal(path = fs::path_temp())
```

You can then use `oxcAAR::executeOxcalScript()` to run our CQL script.
You will need to capture the path to the output file and then parse it with `oxcAAR::readOxcalOutput()` and `oxcAAR::parseOxcalOutput()`.

```{r oxcaar-execute, results=FALSE, message=FALSE}
executeOxcalScript(oxcal_cql) %>% 
  readOxcalOutput() %>% 
  parseOxcalOutput() ->
  oxcal_output
```

The result is an `oxcAARCalibratedDatesList` object containing the output returned by OxCal.
Simple models (such as a list of calibrated dates) can be visualised using the built-in plotting functions in oxcAAR:

```{r oxcaar-plot, fig.show="hold"}
plot(oxcal_output)
calcurve_plot(oxcal_output)
```

## Generating CQL scripts from other types of data

Used in the simple way above, `stratigraphr`'s CQL interface offers little benefit over writing CQL directly.
Its real power is in combining `cql()` with other R tools to build models based on other data.

For the following examples, we will use stratigraphic and radiocarbon data from Shubayqa 1 [@Richter2017-xy]:

```{r shub-data}
data("shub1")
data("shub1_radiocarbon")
```

### Tabular data

Use `dplyr` to quickly generate a CQL script to calibrate a long list of radiocarbon dates from a table.

```{r shub-r-date, message=FALSE}
library("purrr")
library("dplyr")

shub1_radiocarbon %>% 
  mutate(r_date = cql_r_date(lab_id, cra, error)) %>% 
  pluck("r_date") %>% 
  cql()
```

### Stratigraphs

...

## References